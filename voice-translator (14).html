<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ì–æ–ª–æ—Å–æ–≤–æ–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        button {
            flex: 1;
            padding: 15px;
            font-size: 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        #startBtn {
            background: #4CAF50;
            color: white;
        }

        #startBtn:hover {
            background: #45a049;
        }

        #startBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #stopBtn {
            background: #f44336;
            color: white;
        }

        #stopBtn:hover {
            background: #da190b;
        }

        #stopBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 16px;
            color: #666;
        }

        .status.listening {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .status.translating {
            background: #fff3e0;
            color: #e65100;
        }

        .audio-visualizer {
            margin-bottom: 20px;
        }

        .visualizer-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .visualizer-bar {
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .visualizer-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f44336);
            width: 0%;
            transition: width 0.1s;
            border-radius: 15px;
        }

        .visualizer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .history {
            margin-top: 30px;
        }

        .history h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 15px;
        }

        .translation-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .original {
            color: #666;
            margin-bottom: 8px;
        }

        .translated {
            color: #333;
            font-weight: 500;
        }

        .lang-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .lang-ru {
            background: #e3f2fd;
            color: #1976d2;
        }

        .lang-en {
            background: #fce4ec;
            color: #c2185b;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéôÔ∏è –ì–æ–ª–æ—Å–æ–≤–æ–π –ø–µ—Ä–µ–≤–æ–¥—á–∏–∫</h1>
        
        <div class="controls">
            <button id="startBtn">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
            <button id="stopBtn" disabled>‚èπÔ∏è –°—Ç–æ–ø</button>
        </div>

        <div id="status" class="status">–ù–∞–∂–º–∏—Ç–µ "–°—Ç–∞—Ä—Ç" –¥–ª—è –Ω–∞—á–∞–ª–∞</div>

        <div class="audio-visualizer">
            <div class="visualizer-label">–£—Ä–æ–≤–µ–Ω—å –∑–≤—É–∫–∞:</div>
            <div class="visualizer-bar">
                <div id="visualizerFill" class="visualizer-fill"></div>
                <div id="visualizerText" class="visualizer-text">0%</div>
            </div>
        </div>

        <div class="history">
            <h2>–ò—Å—Ç–æ—Ä–∏—è –ø–µ—Ä–µ–≤–æ–¥–æ–≤:</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const status = document.getElementById('status');
        const historyList = document.getElementById('historyList');
        const visualizerFill = document.getElementById('visualizerFill');
        const visualizerText = document.getElementById('visualizerText');

        let recognition;
        let isListening = false;
        let collectedText = '';
        let pauseTimer = null;
        let isTranslating = false;
        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let mediaStream; // –•—Ä–∞–Ω–∏–º –ø–æ—Ç–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è —Ä–µ—á–∏
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'ru-RU';
            
            console.log('Speech recognition initialized:', recognition);
        } else {
            alert('–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Google Chrome.');
        }

        // –ê—É–¥–∏–æ–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        async function startAudioVisualization() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;

                mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                microphone = audioContext.createMediaStreamSource(mediaStream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 1024;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = function() {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteFrequencyData(array);
                    const values = array.reduce((a, b) => a + b, 0);
                    const average = values / array.length;
                    const percent = Math.round((average / 255) * 100);
                    
                    visualizerFill.style.width = percent + '%';
                    visualizerText.textContent = percent + '%';
                };

                return true;
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', err);
                status.textContent = '‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.';
                status.className = 'status';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                isListening = false;
                return false;
            }
        }

        function stopAudioVisualization() {
            if (javascriptNode) {
                javascriptNode.disconnect();
            }
            if (analyser) {
                analyser.disconnect();
            }
            if (microphone) {
                microphone.disconnect();
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            visualizerFill.style.width = '0%';
            visualizerText.textContent = '0%';
        }

        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞
        function detectLanguage(text) {
            const cyrillicPattern = /[–∞-—è–ê-–Ø—ë–Å]/;
            return cyrillicPattern.test(text) ? 'ru' : 'en';
        }

        // –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–µ–∑ LibreTranslate (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π, open-source)
        async function translateText(text, sourceLang) {
            const targetLang = sourceLang === 'ru' ? 'en' : 'ru';
            
            try {
                // LibreTranslate –ø—É–±–ª–∏—á–Ω—ã–π API
                const url = 'https://libretranslate.com/translate';
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        q: text,
                        source: sourceLang,
                        target: targetLang,
                        format: 'text'
                    })
                });
                
                const data = await response.json();
                
                if (data.translatedText) {
                    return data.translatedText;
                } else {
                    // –ï—Å–ª–∏ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º MyMemory –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π
                    console.log('LibreTranslate –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º MyMemory');
                    const backupUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
                    const backupResponse = await fetch(backupUrl);
                    const backupData = await backupResponse.json();
                    
                    if (backupData.responseData && backupData.responseData.translatedText) {
                        return backupData.responseData.translatedText;
                    }
                    
                    return '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
                
                // –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç - MyMemory
                try {
                    const backupUrl = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLang}|${targetLang}`;
                    const backupResponse = await fetch(backupUrl);
                    const backupData = await backupResponse.json();
                    
                    if (backupData.responseData && backupData.responseData.translatedText) {
                        return backupData.responseData.translatedText;
                    }
                } catch (e) {
                    console.error('–ó–∞–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–≤–æ–¥ —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:', e);
                }
                
                return '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞';
            }
        }

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        function addToHistory(original, translated, sourceLang) {
            const item = document.createElement('div');
            item.className = 'translation-item';
            item.innerHTML = `
                <div class="original">
                    <span class="lang-badge lang-${sourceLang}">${sourceLang.toUpperCase()}</span>
                    ${original}
                </div>
                <div class="translated">
                    <span class="lang-badge lang-${sourceLang === 'ru' ? 'en' : 'ru'}">${sourceLang === 'ru' ? 'EN' : 'RU'}</span>
                    ${translated}
                </div>
            `;
            historyList.insertBefore(item, historyList.firstChild);
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
        recognition.onresult = function(event) {
            console.log('üì¢ onresult called! Events:', event.results.length);
            
            // –ï—Å–ª–∏ –∏–¥—ë—Ç –ø–µ—Ä–µ–≤–æ–¥ –∏–ª–∏ –æ–∑–≤—É—á–∫–∞ - –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
            if (isTranslating || speechSynthesis.speaking) {
                console.log('–ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º - –∏–¥—ë—Ç –ø–µ—Ä–µ–≤–æ–¥/–æ–∑–≤—É—á–∫–∞');
                return;
            }
            
            clearTimeout(pauseTimer);
            
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                console.log(`Result ${i}: "${transcript}" (final: ${event.results[i].isFinal})`);
                if (event.results[i].isFinal) {
                    collectedText += transcript + ' ';
                } else {
                    interimTranscript = transcript;
                }
            }

            const displayText = collectedText + interimTranscript;
            console.log('Display text:', displayText);
            status.textContent = `üé§ –°–ª—É—à–∞—é: ${displayText}`;

            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 3 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–ª–æ–≤–∞
            pauseTimer = setTimeout(async () => {
                if (collectedText.trim() && !isTranslating) {
                    isTranslating = true;
                    console.log('–ù–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ–≤–æ–¥:', collectedText.trim());
                    
                    status.textContent = '‚è≥ –ü–µ—Ä–µ–≤–æ–∂—É...';
                    status.className = 'status translating';

                    const textToTranslate = collectedText.trim();
                    const sourceLang = detectLanguage(textToTranslate);
                    const translated = await translateText(textToTranslate, sourceLang);
                    
                    console.log('–ü–µ—Ä–µ–≤–æ–¥ –ø–æ–ª—É—á–µ–Ω:', translated);
                    
                    addToHistory(textToTranslate, translated, sourceLang);
                    
                    // –û—á–∏—â–∞–µ–º –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
                    collectedText = '';
                    isTranslating = false;
                    
                    // –°—Ä–∞–∑—É –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏—é
                    if (isListening) {
                        status.textContent = 'üé§ –°–ª—É—à–∞—é...';
                        status.className = 'status listening';
                        console.log('–ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–º—É —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—é');
                    }
                }
            }, 3000);
        };

        recognition.onerror = function(event) {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', event.error);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏
            if (event.error === 'not-allowed') {
                status.textContent = '‚ùå –î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
                status.className = 'status';
                isListening = false;
            }
            // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –æ—à–∏–±–∫–∏ –ø—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä—É–µ–º, –Ω–æ –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º
        };

        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        startBtn.onclick = async function() {
            startBtn.disabled = true;
            status.textContent = '‚è≥ –ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...';
            
            const audioOk = await startAudioVisualization();
            
            if (audioOk) {
                isListening = true;
                stopBtn.disabled = false;
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏
                try {
                    recognition.start();
                    status.textContent = 'üé§ –°–ª—É—à–∞—é...';
                    status.className = 'status listening';
                } catch (err) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è:', err);
                    status.textContent = '‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è';
                    startBtn.disabled = false;
                    stopBtn.disabled = true;
                    isListening = false;
                }
            }
        };

        stopBtn.onclick = function() {
            isListening = false;
            isTranslating = false;
            startBtn.disabled = false;
            stopBtn.disabled = true;
            recognition.stop();
            clearTimeout(pauseTimer);
            stopAudioVisualization();
            status.textContent = '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
            status.className = 'status';
            collectedText = '';
        };
    </script>
</body>
</html>
